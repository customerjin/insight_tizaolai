# Daily Macro Liquidity Pipeline
# Runs at 00:00 UTC (08:00 UTC+8) every day
# Generates latest.json and deploys to Vercel via git push

name: Daily Liquidity Update

on:
  schedule:
    # 00:00 UTC = 08:00 Beijing Time
    - cron: '0 0 * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pandas numpy matplotlib requests pyyaml

      - name: Run pipeline
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          cd macro_liquidity_daily
          # Override FRED key from secret if available
          if [ -n "$FRED_API_KEY" ]; then
            python -c "
import yaml
with open('config.yaml','r') as f: cfg = yaml.safe_load(f)
cfg['fred_api_key'] = '$FRED_API_KEY'
with open('config.yaml','w') as f: yaml.dump(cfg, f, default_flow_style=False)
"
          fi
          python run_daily.py
          echo "Pipeline complete"

      - name: Copy latest.json to web
        run: |
          cp macro_liquidity_daily/output/web/latest.json macro_liquidity_daily/web/data/latest.json
          echo "Copied latest.json to web/data/"
          ls -la macro_liquidity_daily/web/data/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add macro_liquidity_daily/web/data/latest.json
          git diff --staged --quiet || git commit -m "chore: daily liquidity update $(date -u +%Y-%m-%d)"
          git push
